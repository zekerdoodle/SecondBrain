<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Diet Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<style>
/* === Second Brain Theme Variables === */
:root, [data-theme="light"] {
  --bg-primary: #FAF9F7;
  --bg-secondary: #FFFFFF;
  --bg-tertiary: #F5F4F2;
  --text-primary: #1a1a1a;
  --text-secondary: #6B6B6B;
  --text-muted: #9CA3AF;
  --border-color: #E8E6E3;
  --border-hover: #D4D2CF;
  --accent-primary: #D97757;
  --accent-hover: #C4684A;
  --accent-light: #FDF4F1;
  --accent-r: 217;
  --accent-g: 119;
  --accent-b: 87;
  --success: #10B981;
  --warning: #F59E0B;
  --error: #EF4444;
  --sp-xs: 4px; --sp-sm: 8px; --sp-md: 12px; --sp-lg: 16px; --sp-xl: 20px; --sp-2xl: 24px;
  --radius-sm: 4px; --radius-md: 8px; --radius-lg: 10px; --radius-xl: 12px; --radius-2xl: 16px; --radius-full: 9999px;
  --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  --font-mono: 'SF Mono', 'Fira Code', monospace;
  --font-size-xs: 11px; --font-size-sm: 12px; --font-size-base: 13px; --font-size-md: 14px;
  --font-size-lg: 16px; --font-size-xl: 18px; --font-size-2xl: 22px;
  --ease-fast: 0.15s ease; --ease-normal: 0.2s ease; --ease-slow: 0.3s ease;
  --z-base: 1; --z-sticky: 50; --z-modal: 200; --z-toast: 300;
}

[data-theme="dark"] {
  --bg-primary: #1a1a1a;
  --bg-secondary: #242424;
  --bg-tertiary: #2d2d2d;
  --text-primary: #f5f5f5;
  --text-secondary: #a0a0a0;
  --text-muted: #6b6b6b;
  --border-color: #3d3d3d;
  --border-hover: #4d4d4d;
  --success: #34D399;
  --warning: #FBBF24;
  --error: #F87171;
}

/* === Base Reset === */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: var(--font-sans);
  font-size: var(--font-size-md);
  line-height: 1.5;
  background: var(--bg-primary);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
  padding-bottom: 70px;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: var(--radius-full); }
::-webkit-scrollbar-thumb:hover { background: var(--border-hover); }

/* === TAB NAV (bottom) === */
.tab-bar {
  display: flex; background: var(--bg-secondary); border-top: 1px solid var(--border-color);
  position: fixed; bottom: 0; left: 0; right: 0; z-index: var(--z-sticky);
}
.tab-btn {
  flex: 1; padding: 10px 4px 8px; text-align: center; cursor: pointer;
  color: var(--text-muted); font-size: 10px; font-weight: 600; letter-spacing: 0.3px;
  border: none; background: none; border-top: 2px solid transparent;
  transition: color var(--ease-normal), border-color var(--ease-normal);
  display: flex; flex-direction: column; align-items: center; gap: 3px;
  font-family: inherit;
}
.tab-btn:hover { color: var(--text-secondary); }
.tab-btn.active { color: var(--accent-primary); border-top-color: var(--accent-primary); }
.tab-icon { font-size: 18px; }

/* === MAIN CONTENT === */
main { padding: var(--sp-lg); max-width: 600px; margin: 0 auto; }
.tab-content { display: none; }
.tab-content.active { display: block; }

/* === CARDS === */
.card {
  background: var(--bg-secondary); border-radius: var(--radius-xl);
  padding: var(--sp-lg); margin-bottom: var(--sp-md);
  border: 1px solid var(--border-color);
}
.card-header { font-size: var(--font-size-md); font-weight: 600; margin-bottom: var(--sp-sm); color: var(--text-primary); }
.card-sub { font-size: var(--font-size-sm); color: var(--text-muted); }

/* === BUTTONS === */
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: var(--sp-sm);
  border: none; border-radius: var(--radius-lg); padding: 12px 20px; cursor: pointer;
  font-weight: 600; font-size: var(--font-size-md); font-family: inherit;
  transition: background var(--ease-normal), opacity var(--ease-normal);
  -webkit-tap-highlight-color: transparent; user-select: none;
}
.btn-primary { background: var(--accent-primary); color: var(--bg-secondary); }
.btn-primary:hover:not(:disabled) { background: var(--accent-hover); }
.btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
.btn-secondary:hover:not(:disabled) { background: var(--border-color); }
.btn-success { background: var(--success); color: var(--bg-secondary); }
.btn-success:hover:not(:disabled) { opacity: 0.9; }
.btn-danger { background: var(--error); color: var(--bg-secondary); }
.btn-danger:hover:not(:disabled) { opacity: 0.9; }
.btn-large { padding: 14px 28px; font-size: var(--font-size-lg); width: 100%; border-radius: var(--radius-xl); }
.btn:disabled { opacity: 0.4; cursor: not-allowed; }
.btn-ghost { background: none; color: var(--text-muted); padding: var(--sp-sm) var(--sp-md); font-size: var(--font-size-sm); }
.btn-ghost:hover { color: var(--text-primary); }

/* === INPUTS === */
input, textarea, select {
  background: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary);
  padding: var(--sp-md) var(--sp-lg); border-radius: var(--radius-lg); font-size: var(--font-size-md);
  width: 100%; font-family: inherit; outline: none;
  -webkit-appearance: none;
  transition: border-color var(--ease-normal);
}
input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent-primary); }
input[type="number"] { font-size: 28px; font-weight: 700; text-align: center; padding: var(--sp-lg); }
textarea { resize: vertical; min-height: 60px; font-family: inherit; }

/* === STAT BADGES === */
.stat-row { display: flex; gap: var(--sp-md); margin-bottom: var(--sp-md); flex-wrap: wrap; }
.stat-badge {
  flex: 1; min-width: 80px; background: var(--bg-secondary); border-radius: var(--radius-lg);
  padding: var(--sp-md); text-align: center; border: 1px solid var(--border-color);
}
.stat-value { font-size: var(--font-size-2xl); font-weight: 700; color: var(--accent-primary); }
.stat-label { font-size: var(--font-size-xs); color: var(--text-muted); margin-top: 2px; }

/* === MACRO BAR === */
.macro-bar {
  display: flex; gap: var(--sp-lg); padding: var(--sp-md) var(--sp-lg); background: var(--bg-tertiary);
  border-radius: var(--radius-lg); margin-bottom: var(--sp-lg); align-items: center;
  border: 1px solid var(--border-color);
}
.macro-item { text-align: center; flex: 1; }
.macro-current { font-size: var(--font-size-xl); font-weight: 700; }
.macro-target { font-size: var(--font-size-xs); color: var(--text-muted); }
.macro-label { font-size: 10px; color: var(--text-muted); margin-top: 2px; }
.macro-progress {
  height: 3px; background: var(--border-color); border-radius: 2px; margin-top: 4px; overflow: hidden;
}
.macro-progress-fill { height: 100%; border-radius: 2px; transition: width 0.3s; }

/* === MEAL CARDS === */
.meal-section { margin-bottom: var(--sp-lg); }
.meal-section-header {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: var(--sp-sm); padding: 0 4px;
}
.meal-section-title { font-size: var(--font-size-md); font-weight: 600; color: var(--text-primary); }
.meal-section-time { font-size: var(--font-size-sm); color: var(--text-muted); }
.meal-section-target { font-size: var(--font-size-xs); color: var(--text-muted); }

.meal-card {
  background: var(--bg-secondary); border-radius: var(--radius-xl); padding: 14px var(--sp-lg);
  margin-bottom: var(--sp-sm); border: 2px solid var(--border-color); cursor: pointer;
  transition: all var(--ease-fast); -webkit-tap-highlight-color: transparent;
}
.meal-card:hover { border-color: var(--border-hover); }
.meal-card:active { transform: scale(0.98); }
.meal-card.selected {
  border-color: var(--success);
  background: rgba(var(--accent-r),var(--accent-g),var(--accent-b),0.06);
}
.meal-card.selected::after { content: none; }
.meal-card-label { font-size: var(--font-size-md); font-weight: 600; margin-bottom: 4px; }
.meal-card-macros { font-size: var(--font-size-sm); color: var(--text-secondary); }
.meal-card-items {
  margin-top: var(--sp-sm); padding-top: var(--sp-sm); border-top: 1px solid var(--border-color);
  display: none; font-size: var(--font-size-sm); color: var(--text-muted);
}
.meal-card-items.expanded { display: block; }
.meal-card-item { padding: 3px 0; display: flex; justify-content: space-between; }
.meal-card-item-name { flex: 1; }
.meal-card-item-amount { color: var(--text-muted); margin-left: var(--sp-sm); white-space: nowrap; }
.meal-card-check { color: var(--success); font-weight: 700; margin-right: var(--sp-sm); }

.meal-custom-card {
  background: var(--bg-primary); border: 2px dashed var(--border-color); border-radius: var(--radius-xl);
  padding: 14px var(--sp-lg); margin-bottom: var(--sp-sm); cursor: pointer; text-align: center;
  color: var(--text-muted); font-size: var(--font-size-base); transition: all var(--ease-fast);
}
.meal-custom-card:hover { border-color: var(--accent-primary); color: var(--accent-primary); }

.meal-done {
  background: var(--bg-tertiary); border-radius: var(--radius-lg); padding: var(--sp-md) 14px;
  margin-bottom: 6px; display: flex; align-items: center; gap: var(--sp-sm);
  font-size: var(--font-size-base); color: var(--text-secondary);
  border: 1px solid var(--border-color);
}
.meal-done-check { color: var(--success); }
.meal-done-label { flex: 1; }
.meal-done-macros { font-size: var(--font-size-xs); color: var(--text-muted); }

.meal-future {
  background: var(--bg-tertiary); border-radius: var(--radius-lg); padding: var(--sp-md) 14px;
  margin-bottom: 6px; opacity: 0.5; font-size: var(--font-size-base); color: var(--text-muted);
  display: flex; justify-content: space-between; border: 1px solid var(--border-color);
}

/* === FEEL BUTTONS === */
.feel-row { display: flex; gap: var(--sp-sm); margin: var(--sp-md) 0; }
.feel-btn {
  flex: 1; padding: 14px 4px; border-radius: var(--radius-lg); border: 2px solid var(--border-color);
  background: var(--bg-secondary); color: var(--text-primary); cursor: pointer; text-align: center;
  font-size: var(--font-size-sm); font-weight: 600; transition: all var(--ease-fast);
  -webkit-tap-highlight-color: transparent;
}
.feel-btn:hover { border-color: var(--border-hover); }
.feel-btn.active { border-color: var(--accent-primary); background: rgba(var(--accent-r),var(--accent-g),var(--accent-b),0.08); }
.feel-num { font-size: 20px; display: block; margin-bottom: 2px; }

/* === SUMMARY CARD === */
.summary-card { text-align: center; padding: var(--sp-2xl) var(--sp-lg); }
.summary-title { font-size: var(--font-size-xl); font-weight: 700; margin-bottom: var(--sp-lg); }
.summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--sp-md); margin-bottom: var(--sp-lg); }
.summary-item {
  background: var(--bg-secondary); border-radius: var(--radius-lg); padding: var(--sp-md);
  border: 1px solid var(--border-color);
}
.summary-value { font-size: 20px; font-weight: 700; color: var(--accent-primary); }
.summary-label { font-size: var(--font-size-xs); color: var(--text-muted); margin-top: 2px; }

/* === CHART === */
.chart-container { position: relative; width: 100%; margin-bottom: var(--sp-lg); }
.chart-container canvas { width: 100% !important; }

/* === ACCORDION === */
.accordion { margin-bottom: var(--sp-sm); }
.accordion-header {
  background: var(--bg-secondary); border-radius: var(--radius-lg); padding: var(--sp-md) var(--sp-lg);
  cursor: pointer; display: flex; justify-content: space-between; align-items: center;
  border: 1px solid var(--border-color); font-size: var(--font-size-base); font-weight: 600;
  transition: all var(--ease-fast);
}
.accordion-header:hover { background: var(--bg-tertiary); }
.accordion-body {
  display: none; padding: var(--sp-md) var(--sp-lg); background: var(--bg-tertiary);
  border-radius: 0 0 var(--radius-lg) var(--radius-lg);
  border: 1px solid var(--border-color); border-top: none;
  font-size: var(--font-size-base);
}
.accordion-body.open { display: block; }
.accordion-header.open { border-radius: var(--radius-lg) var(--radius-lg) 0 0; }

/* === HISTORY LIST === */
.history-day {
  background: var(--bg-secondary); border-radius: var(--radius-lg); padding: 14px var(--sp-lg);
  margin-bottom: var(--sp-sm); border: 1px solid var(--border-color); cursor: pointer;
  transition: all var(--ease-fast);
}
.history-day:hover { background: var(--bg-tertiary); }
.history-day.feel-good { background: rgba(var(--accent-r),var(--accent-g),var(--accent-b),0.06); }
.history-day.feel-bad { background: rgba(239,68,68,0.05); }
.history-day-header { display: flex; justify-content: space-between; align-items: center; }
.history-day-date { font-size: var(--font-size-md); font-weight: 600; }
.history-day-weight { font-size: var(--font-size-base); color: var(--accent-primary); }
.history-day-macros { font-size: var(--font-size-sm); color: var(--text-muted); margin-top: 4px; }
.history-day-detail {
  display: none; margin-top: var(--sp-md); padding-top: var(--sp-md);
  border-top: 1px solid var(--border-color); font-size: var(--font-size-sm); color: var(--text-secondary);
}
.history-day-detail.open { display: block; }
.history-meal-line { padding: 3px 0; display: flex; justify-content: space-between; }
.history-feel { margin-top: 6px; color: var(--text-muted); }
.history-notes { margin-top: 4px; font-style: italic; color: var(--text-muted); }

/* === MEALS BROWSE === */
.browse-slot { margin-bottom: var(--sp-lg); }
.browse-slot-header {
  font-size: var(--font-size-md); font-weight: 700; margin-bottom: 4px; color: var(--text-primary);
}
.browse-slot-sub { font-size: var(--font-size-sm); color: var(--text-muted); margin-bottom: var(--sp-md); }
.browse-option {
  background: var(--bg-secondary); border-radius: var(--radius-lg); padding: var(--sp-md) var(--sp-lg);
  margin-bottom: 6px; border: 1px solid var(--border-color); cursor: pointer;
  transition: all var(--ease-fast);
}
.browse-option:hover { background: var(--bg-tertiary); }
.browse-option-header { display: flex; justify-content: space-between; align-items: center; }
.browse-option-label { font-size: var(--font-size-base); font-weight: 600; }
.browse-option-macros { font-size: var(--font-size-sm); color: var(--text-secondary); }
.browse-option-badge {
  font-size: 10px; background: var(--bg-tertiary); color: var(--text-secondary); border-radius: 6px;
  padding: 2px 6px; margin-left: var(--sp-sm);
}
.browse-option-items {
  display: none; margin-top: var(--sp-sm); padding-top: var(--sp-sm); border-top: 1px solid var(--border-color);
  font-size: var(--font-size-sm); color: var(--text-muted);
}
.browse-option-items.open { display: block; }

/* === SETTINGS === */
.settings-section { margin-bottom: 20px; }
.settings-label { font-size: var(--font-size-sm); color: var(--text-muted); margin-bottom: 6px; font-weight: 600; }
.settings-value { font-size: var(--font-size-md); margin-bottom: var(--sp-md); }

/* === GREETING === */
.greeting { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
.greeting-sub { font-size: var(--font-size-md); color: var(--text-muted); margin-bottom: var(--sp-2xl); }

/* === WEIGHT INPUT === */
.weight-input-wrap { margin-bottom: var(--sp-lg); text-align: center; }
.weight-input-wrap label {
  font-size: var(--font-size-base); color: var(--text-muted); display: block; margin-bottom: var(--sp-sm);
}
.yesterday-ref { font-size: var(--font-size-sm); color: var(--text-muted); margin-top: var(--sp-sm); }

/* === MODALS === */
.modal-overlay {
  display: flex; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.7); z-index: var(--z-modal); align-items: center; justify-content: center;
  padding: var(--sp-lg); opacity: 0; pointer-events: none; transition: opacity var(--ease-normal);
}
.modal-overlay.open { opacity: 1; pointer-events: auto; }
.modal {
  background: var(--bg-secondary); border-radius: var(--radius-2xl); padding: 20px; width: 100%;
  max-width: 400px; border: 1px solid var(--border-color);
}
.modal-title { font-size: var(--font-size-lg); font-weight: 700; margin-bottom: var(--sp-md); }
.modal-actions { display: flex; gap: var(--sp-sm); margin-top: var(--sp-md); }
.modal-actions .btn { flex: 1; }

.confirm-overlay {
  display: flex; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.7); z-index: 250; align-items: center; justify-content: center;
  padding: var(--sp-lg); opacity: 0; pointer-events: none; transition: opacity var(--ease-normal);
}
.confirm-overlay.open { opacity: 1; pointer-events: auto; }

/* === TOAST (BrainKit compat) === */
.toast {
  position: fixed; top: var(--sp-lg); left: 50%;
  transform: translateX(-50%) translateY(-100px);
  background: var(--bg-secondary); color: var(--text-primary);
  padding: var(--sp-md) var(--sp-xl); border-radius: var(--radius-lg);
  font-size: var(--font-size-base); font-weight: 600;
  z-index: var(--z-toast); border: 1px solid var(--border-color);
  transition: transform var(--ease-slow); pointer-events: none;
}
.toast.show { transform: translateX(-50%) translateY(0); }
.toast.error { border-color: var(--error); color: var(--error); }
.toast.success { border-color: var(--success); color: var(--success); }
.toast.warning { border-color: var(--warning); color: var(--warning); }

/* === ESCALATION NOTE === */
.escalation-note {
  background: rgba(var(--accent-r),var(--accent-g),var(--accent-b),0.08);
  border-radius: var(--radius-md); padding: var(--sp-md) 14px; margin-top: var(--sp-md);
  font-size: var(--font-size-sm); color: var(--accent-primary); border-left: 3px solid var(--accent-primary);
}

/* === UNDO / RESET === */
.undo-btn {
  background: none; border: none; color: var(--text-muted); font-size: var(--font-size-xs); cursor: pointer;
  padding: 4px var(--sp-sm); margin-left: 4px;
}
.undo-btn:hover { color: var(--error); }

.today-header { display: flex; justify-content: flex-end; margin-bottom: 4px; }
.reset-btn {
  background: none; border: none; color: var(--text-muted); font-size: var(--font-size-xs); cursor: pointer;
  padding: 4px var(--sp-sm); transition: color var(--ease-fast);
}
.reset-btn:hover { color: var(--error); }

/* === ANIMATIONS === */
@keyframes slideIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
.animate-in { animation: slideIn 0.2s ease-out; }

@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
.meal-polling {
  background: rgba(var(--accent-r),var(--accent-g),var(--accent-b),0.06);
  border-radius: var(--radius-lg); padding: var(--sp-md) 14px; margin-bottom: 6px;
  display: flex; align-items: center; gap: var(--sp-md); font-size: var(--font-size-base);
  color: var(--accent-primary); animation: pulse 1.5s ease-in-out infinite;
  border: 1px solid rgba(var(--accent-r),var(--accent-g),var(--accent-b),0.2);
}
.meal-polling-dot {
  width: 8px; height: 8px; border-radius: 50%; background: var(--accent-primary);
  animation: pulse 1s ease-in-out infinite;
}
</style>
<script>
// Second Brain Theme Bridge — reads parent app's theme from localStorage
(function() {
  const STORAGE_KEY = 'second-brain-theme';
  const defaults = { mode: 'light', accentColor: '#D97757', accentHover: '#C4684A' };

  function hexToRgb(hex) {
    const r = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return r ? { r: parseInt(r[1],16), g: parseInt(r[2],16), b: parseInt(r[3],16) } : null;
  }

  function applyTheme() {
    let prefs = defaults;
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) prefs = { ...defaults, ...JSON.parse(stored) };
    } catch(e) {}

    let mode = prefs.mode;
    if (mode === 'system') {
      mode = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }

    document.documentElement.setAttribute('data-theme', mode);
    document.documentElement.style.setProperty('--accent-primary', prefs.accentColor);
    document.documentElement.style.setProperty('--accent-hover', prefs.accentHover);

    const rgb = hexToRgb(prefs.accentColor);
    if (rgb) {
      document.documentElement.style.setProperty('--accent-r', rgb.r);
      document.documentElement.style.setProperty('--accent-g', rgb.g);
      document.documentElement.style.setProperty('--accent-b', rgb.b);
    }

    const accentLight = prefs.accentColor + '15';
    document.documentElement.style.setProperty('--accent-light', accentLight);
  }

  applyTheme();

  window.addEventListener('storage', function(e) {
    if (e.key === STORAGE_KEY) applyTheme();
  });

  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyTheme);
})();
</script>
</head>
<body>

<main>
  <!-- TAB: TODAY -->
  <div id="tab-today" class="tab-content active">
    <div id="today-content"></div>
  </div>

  <!-- TAB: PROGRESS -->
  <div id="tab-progress" class="tab-content">
    <div id="progress-content"></div>
  </div>

  <!-- TAB: MEALS -->
  <div id="tab-meals" class="tab-content">
    <div id="meals-content"></div>
  </div>

  <!-- TAB: HISTORY -->
  <div id="tab-history" class="tab-content">
    <div id="history-content"></div>
  </div>

  <!-- TAB: SETTINGS -->
  <div id="tab-settings" class="tab-content">
    <div id="settings-content"></div>
  </div>
</main>

<!-- Bottom Nav -->
<nav class="tab-bar">
  <button class="tab-btn active" data-tab="today"><span class="tab-icon">&#9737;</span>Today</button>
  <button class="tab-btn" data-tab="progress"><span class="tab-icon">&#9650;</span>Progress</button>
  <button class="tab-btn" data-tab="meals"><span class="tab-icon">&#9783;</span>Meals</button>
  <button class="tab-btn" data-tab="history"><span class="tab-icon">&#128197;</span>History</button>
  <button class="tab-btn" data-tab="settings"><span class="tab-icon">&#9881;</span>Settings</button>
</nav>

<!-- Custom Meal Modal -->
<div id="custom-modal" class="modal-overlay">
  <div class="modal">
    <div class="modal-title">Custom Meal</div>
    <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px;">Describe what you ate. Claude will estimate the macros.</p>
    <textarea id="custom-meal-text" placeholder="e.g., Two scrambled eggs with toast and butter"></textarea>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeCustomModal()">Cancel</button>
      <button class="btn btn-primary" onclick="submitCustomMeal()">Send</button>
    </div>
  </div>
</div>

<!-- Confirm Modal -->
<div id="confirm-modal" class="confirm-overlay">
  <div class="modal">
    <div class="modal-title">Reset Today</div>
    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px;">Reset today's data? This can't be undone.</p>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeConfirmModal()">Cancel</button>
      <button class="btn btn-danger" onclick="confirmResetToday()">Reset</button>
    </div>
  </div>
</div>

<!-- Toast notifications handled by BrainKit -->

<script src="/file/05_App_Data/_shared/brain-kit.js"></script>
<script>
// ============================================================
// STATE
// ============================================================
let mealPlan = null;
let dailyLog = {};
let todayKey = '';
let weightChart = null;
let currentCustomSlot = 0;
let customMealLoading = null; // slot number while Claude is estimating

// ============================================================
// HELPERS
// ============================================================
function getToday() {
  const d = new Date();
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}

function formatDate(dateStr) {
  const d = new Date(dateStr + 'T12:00:00');
  return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
}

function getGreeting() {
  const h = new Date().getHours();
  if (h < 12) return 'Good morning';
  if (h < 17) return 'Good afternoon';
  return 'Good evening';
}

function cssVar(name) {
  return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
}

// notify() removed — using BrainKit.toast() instead

function getOptionById(id) {
  if (!mealPlan) return null;
  for (const meal of mealPlan.meals) {
    for (const opt of meal.options) {
      if (opt.id === id) return opt;
    }
  }
  return null;
}

function getMealBySlot(slot) {
  if (!mealPlan) return null;
  return mealPlan.meals.find(m => m.slot === slot) || null;
}

function getTodayData() {
  return dailyLog[todayKey] || null;
}

function getTodayTotals() {
  const today = getTodayData();
  if (!today) return { cal: 0, protein: 0 };
  let cal = 0, protein = 0;
  if (today.meals) {
    for (const m of today.meals) {
      const opt = getOptionById(m.option_id);
      if (opt) { cal += opt.total_cal; protein += opt.total_protein; }
    }
  }
  if (today.custom_meals) {
    for (const cm of today.custom_meals) {
      const macros = getCustomMealMacros(cm);
      cal += macros.cal;
      protein += macros.protein;
    }
  }
  return { cal, protein };
}

function getLoggedSlots() {
  const today = getTodayData();
  if (!today) return new Set();
  const slots = new Set();
  if (today.meals) today.meals.forEach(m => slots.add(m.slot));
  if (today.custom_meals) today.custom_meals.forEach(m => slots.add(m.slot));
  return slots;
}

function getNextSlot() {
  const logged = getLoggedSlots();
  for (let i = 1; i <= 5; i++) {
    if (!logged.has(i)) return i;
  }
  return -1;
}

function getDayTotals(dayData) {
  let cal = 0, protein = 0;
  if (dayData.meals) {
    for (const m of dayData.meals) {
      const opt = getOptionById(m.option_id);
      if (opt) { cal += opt.total_cal; protein += opt.total_protein; }
    }
  }
  if (dayData.custom_meals) {
    for (const cm of dayData.custom_meals) {
      const macros = getCustomMealMacros(cm);
      cal += macros.cal;
      protein += macros.protein;
    }
  }
  return { cal, protein };
}

function getCustomMealMacros(cm) {
  return {
    cal: cm.estimated_cal || cm.cal || 0,
    protein: cm.estimated_protein || cm.protein || 0
  };
}

function getCustomMealItemsLabel(cm) {
  if (cm.items && cm.items.length) return cm.items.join(', ');
  return cm.description || 'Custom';
}

function getOptionFrequency() {
  const freq = {};
  for (const day of Object.values(dailyLog)) {
    if (day.meals) {
      for (const m of day.meals) {
        freq[m.option_id] = (freq[m.option_id] || 0) + 1;
      }
    }
  }
  return freq;
}

function getSortedDates() {
  return Object.keys(dailyLog).sort().reverse();
}

function getYesterdayWeight() {
  const dates = Object.keys(dailyLog).sort().reverse();
  for (const d of dates) {
    if (d < todayKey && dailyLog[d].weight) return dailyLog[d].weight;
  }
  return null;
}

// ============================================================
// PERSISTENCE (BrainKit.store)
// ============================================================
const store = BrainKit.store('diet');

async function loadData() {
  mealPlan = await store.read('meal_plan.json', null);
  dailyLog = await store.read('daily_log.json', {});
}

async function saveLog() {
  try {
    await store.write('daily_log.json', dailyLog);
  } catch (e) {
    console.error('Failed to save log:', e);
    BrainKit.toast('Failed to save', 'error');
  }
}

// ============================================================
// TAB NAVIGATION
// ============================================================
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
    renderTab(btn.dataset.tab);
  });
});

function checkDateChange() {
  const now = getToday();
  if (now !== todayKey) {
    todayKey = now;
    return true;
  }
  return false;
}

function renderTab(tab) {
  checkDateChange();
  switch(tab) {
    case 'today': renderToday(); break;
    case 'progress': renderProgress(); break;
    case 'meals': renderMeals(); break;
    case 'history': renderHistory(); break;
    case 'settings': renderSettings(); break;
  }
}

// ============================================================
// TAB: TODAY
// ============================================================
function renderToday() {
  const container = document.getElementById('today-content');
  const today = getTodayData();

  // Reset button header (only show when today has data)
  const headerHtml = today ? '<div class="today-header"><button class="reset-btn" onclick="openResetConfirm()">Reset Day</button></div>' : '';

  // State: Day complete
  if (today && today.end_of_day && today.end_of_day.feel) {
    renderDaySummary(container, today, headerHtml);
    return;
  }

  // State: No weight logged
  if (!today || !today.weight) {
    renderWeightInput(container);
    return;
  }

  // State: Meals in progress
  renderMealProgress(container, today, headerHtml);
}

function renderWeightInput(container) {
  const yesterday = getYesterdayWeight();
  container.innerHTML = `
    <div class="animate-in" style="padding-top:40px;text-align:center;">
      <div class="greeting">${getGreeting()}</div>
      <div class="greeting-sub">Let's start with your weight</div>
      <div class="weight-input-wrap" style="margin-top:32px;">
        <label>Weight (lbs)</label>
        <input type="number" id="weight-input" step="0.1" min="100" max="400"
               placeholder="225.0" style="max-width:200px;margin:0 auto;"
               inputmode="decimal">
        ${yesterday ? `<div class="yesterday-ref">Yesterday: ${yesterday} lbs</div>` : ''}
      </div>
      <button class="btn btn-primary btn-large" style="max-width:200px;margin:16px auto 0;"
              onclick="logWeight()">Log Weight</button>
    </div>
  `;
  setTimeout(() => document.getElementById('weight-input')?.focus(), 100);
}

function logWeight() {
  const input = document.getElementById('weight-input');
  const val = parseFloat(input.value);
  if (!val || val < 100 || val > 400) {
    BrainKit.toast('Enter a valid weight', 'warning');
    return;
  }
  if (!dailyLog[todayKey]) {
    dailyLog[todayKey] = { weight: 0, weight_time: '', meals: [], custom_meals: [] };
  }
  dailyLog[todayKey].weight = val;
  const now = new Date();
  dailyLog[todayKey].weight_time = String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
  saveLog();
  BrainKit.toast('Weight logged', 'success');
  renderToday();
}

function renderMealProgress(container, today, headerHtml) {
  const totals = getTodayTotals();
  const targets = mealPlan.daily_targets;
  const loggedSlots = getLoggedSlots();
  const nextSlot = getNextSlot();

  // All meals logged — show end-of-day form
  if (nextSlot === -1) {
    renderEndOfDay(container, today, totals);
    return;
  }

  let html = headerHtml || '';

  // Macro bar
  const calPct = Math.min(100, (totals.cal / targets.calories) * 100);
  const proPct = Math.min(100, (totals.protein / targets.protein) * 100);
  html += `
    <div class="macro-bar">
      <div class="macro-item">
        <div class="macro-current">${totals.cal}</div>
        <div class="macro-target">/ ${targets.calories}</div>
        <div class="macro-label">calories</div>
        <div class="macro-progress"><div class="macro-progress-fill" style="width:${calPct}%;background:var(--accent-primary);"></div></div>
      </div>
      <div class="macro-item">
        <div class="macro-current">${totals.protein}g</div>
        <div class="macro-target">/ ${targets.protein}g</div>
        <div class="macro-label">protein</div>
        <div class="macro-progress"><div class="macro-progress-fill" style="width:${proPct}%;background:var(--success);"></div></div>
      </div>
    </div>
  `;

  // Logged meals (compact)
  for (let s = 1; s <= 5; s++) {
    if (!loggedSlots.has(s) || s >= nextSlot) continue;
    const meal = getMealBySlot(s);
    const logged = today.meals.find(m => m.slot === s);
    const opt = logged ? getOptionById(logged.option_id) : null;
    // Check custom
    const customLogged = today.custom_meals ? today.custom_meals.find(m => m.slot === s) : null;

    if (opt) {
      html += `
        <div class="meal-done animate-in">
          <span class="meal-done-check">&#10003;</span>
          <span class="meal-done-label">${meal ? meal.name : 'Meal ' + s}: ${opt.label}</span>
          <span class="meal-done-macros">${opt.total_cal} cal / ${opt.total_protein}g</span>
          <button class="undo-btn" onclick="undoMeal(${s})" title="Undo">&#8630;</button>
        </div>
      `;
    } else if (customLogged) {
      const cmMacros = getCustomMealMacros(customLogged);
      html += `
        <div class="meal-done animate-in">
          <span class="meal-done-check">&#10003;</span>
          <span class="meal-done-label">${meal ? meal.name : 'Meal ' + s}: ${getCustomMealItemsLabel(customLogged)}</span>
          <span class="meal-done-macros">${cmMacros.cal || '?'} cal / ${cmMacros.protein || '?'}g</span>
          <button class="undo-btn" onclick="undoMeal(${s})" title="Undo">&#8630;</button>
        </div>
      `;
    }
  }

  // Current slot — check if loading custom meal estimate
  const isLoading = customMealLoading === nextSlot;
  const currentMeal = getMealBySlot(nextSlot);

  if (isLoading && currentMeal) {
    html += `
      <div class="meal-section animate-in">
        <div class="meal-section-header">
          <div>
            <div class="meal-section-title">${currentMeal.name}</div>
            <div class="meal-section-target">${currentMeal.target_cal} cal / ${currentMeal.target_protein}g protein</div>
          </div>
          <div class="meal-section-time">${currentMeal.time_window}</div>
        </div>
        <div class="meal-polling">
          <span class="meal-polling-dot"></span>
          <span>Estimating macros...</span>
        </div>
      </div>
    `;
  } else if (currentMeal) {
    html += `
      <div class="meal-section animate-in">
        <div class="meal-section-header">
          <div>
            <div class="meal-section-title">${currentMeal.name}</div>
            <div class="meal-section-target">${currentMeal.target_cal} cal / ${currentMeal.target_protein}g protein</div>
          </div>
          <div class="meal-section-time">${currentMeal.time_window}</div>
        </div>
        ${currentMeal.note ? `<div style="font-size:var(--font-size-xs);color:var(--text-muted);margin-bottom:var(--sp-sm);padding:0 4px;">${currentMeal.note}</div>` : ''}
    `;

    for (const opt of currentMeal.options) {
      html += `
        <div class="meal-card" id="card-${opt.id}" onclick="toggleMealDetails('${opt.id}')">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div class="meal-card-label">${opt.label}</div>
          </div>
          <div class="meal-card-macros">${opt.total_cal} cal &middot; ${opt.total_protein}g protein</div>
          <div class="meal-card-items" id="items-${opt.id}">
            ${opt.items.map(it => `
              <div class="meal-card-item">
                <span class="meal-card-item-name">${it.name}</span>
                <span class="meal-card-item-amount">${it.amount} &middot; ${it.cal} cal</span>
              </div>
            `).join('')}
            <button class="btn btn-success" style="margin-top:10px;width:100%;"
                    onclick="event.stopPropagation();selectMeal(${nextSlot},'${opt.id}')">
              Select This
            </button>
          </div>
        </div>
      `;
    }

    html += `
        <div class="meal-custom-card" onclick="openCustomModal(${nextSlot})">+ Custom Meal</div>
      </div>
    `;
  }

  // Future meals (dimmed)
  for (let s = nextSlot + 1; s <= 5; s++) {
    if (loggedSlots.has(s)) continue;
    const meal = getMealBySlot(s);
    if (meal) {
      html += `
        <div class="meal-future">
          <span>${meal.name}</span>
          <span>${meal.time_window}</span>
        </div>
      `;
    }
  }

  container.innerHTML = html;
}

function toggleMealDetails(optId) {
  const items = document.getElementById('items-' + optId);
  if (items) items.classList.toggle('expanded');
}

async function selectMeal(slot, optionId) {
  const today = getTodayData();
  if (!today) return;
  const now = new Date();
  const time = String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
  today.meals.push({ slot, option_id: optionId, time });
  await saveLog();
  BrainKit.toast('Meal logged', 'success');
  renderToday();
}

async function undoMeal(slot) {
  const today = getTodayData();
  if (!today) return;
  today.meals = today.meals.filter(m => m.slot !== slot);
  if (today.custom_meals) {
    today.custom_meals = today.custom_meals.filter(m => m.slot !== slot);
  }
  await saveLog();
  renderToday();
}

function renderEndOfDay(container, today, totals) {
  const targets = mealPlan.daily_targets;
  container.innerHTML = `
    <div class="animate-in">
      <div class="greeting">End of Day</div>
      <div class="greeting-sub">All meals logged. How'd it go?</div>

      <div class="macro-bar" style="margin-top:16px;">
        <div class="macro-item">
          <div class="macro-current">${totals.cal}</div>
          <div class="macro-target">/ ${targets.calories} cal</div>
        </div>
        <div class="macro-item">
          <div class="macro-current">${totals.protein}g</div>
          <div class="macro-target">/ ${targets.protein}g pro</div>
        </div>
      </div>

      <div class="card" style="margin-top:16px;">
        <div class="card-header">How did you feel today?</div>
        <div class="feel-row">
          <div class="feel-btn" onclick="setFeel(1)"><span class="feel-num">1</span>Rough</div>
          <div class="feel-btn" onclick="setFeel(2)"><span class="feel-num">2</span>Meh</div>
          <div class="feel-btn" onclick="setFeel(3)"><span class="feel-num">3</span>Okay</div>
          <div class="feel-btn" onclick="setFeel(4)"><span class="feel-num">4</span>Good</div>
          <div class="feel-btn" onclick="setFeel(5)"><span class="feel-num">5</span>Great</div>
        </div>

        <div style="margin-top:12px;">
          <label style="font-size:var(--font-size-sm);color:var(--text-muted);display:block;margin-bottom:6px;">Steps</label>
          <input type="number" id="eod-steps" placeholder="8000" inputmode="numeric">
        </div>

        <div style="margin-top:12px;">
          <label style="font-size:var(--font-size-sm);color:var(--text-muted);display:block;margin-bottom:6px;">Anything to note?</label>
          <textarea id="eod-notes" placeholder="Optional..."></textarea>
        </div>

        <div style="margin-top:12px;display:flex;align-items:center;gap:10px;">
          <label style="font-size:var(--font-size-base);cursor:pointer;display:flex;align-items:center;gap:8px;">
            <input type="checkbox" id="eod-tweak" style="width:auto;accent-color:var(--accent-primary);">
            Request diet adjustment?
          </label>
        </div>

        <button class="btn btn-primary btn-large" style="margin-top:16px;" id="eod-submit" disabled
                onclick="submitEndOfDay()">Submit</button>
      </div>
    </div>
  `;
}

let selectedFeel = 0;
function setFeel(n) {
  selectedFeel = n;
  document.querySelectorAll('.feel-btn').forEach((btn, i) => {
    btn.classList.toggle('active', i + 1 === n);
  });
  const submit = document.getElementById('eod-submit');
  if (submit) submit.disabled = false;
}

async function submitEndOfDay() {
  if (!selectedFeel) return;
  const today = getTodayData();
  if (!today) return;

  const steps = parseInt(document.getElementById('eod-steps')?.value) || 0;
  const notes = document.getElementById('eod-notes')?.value || '';
  const tweak = document.getElementById('eod-tweak')?.checked || false;

  today.end_of_day = {
    feel: selectedFeel,
    steps,
    notes,
    tweak_requested: tweak,
    escalated_to_claude: false
  };

  // Escalation logic — ask Claude for advice (background, no blocking)
  if (selectedFeel <= 2 || tweak) {
    today.end_of_day.escalated_to_claude = true;
    try {
      const totals = getTodayTotals();
      const targets = mealPlan.daily_targets;
      const mealLabels = today.meals.map(m => {
        const opt = getOptionById(m.option_id);
        const meal = getMealBySlot(m.slot);
        return `${meal?.name || 'Slot ' + m.slot}: ${opt?.label || m.option_id}`;
      }).join(', ');

      const prompt = `Diet tracker end-of-day check-in:
Date: ${todayKey}
Weight: ${today.weight} lbs
Feel: ${selectedFeel}/5
Steps: ${steps}
Notes: ${notes || 'none'}
Tweak requested: ${tweak ? 'yes' : 'no'}
Meals: ${mealLabels}
Totals: ${totals.cal} cal / ${totals.protein}g protein (target: ${targets.calories} / ${targets.protein}g)
${selectedFeel <= 2 ? 'CONCERN: Low feel rating — please review and suggest adjustments.' : ''}
${tweak ? 'CONCERN: Diet adjustment requested — please review the plan.' : ''}

Review this data. If adjustments are warranted, write an updated meal_plan.json to 05_App_Data/diet/meal_plan.json. Otherwise, provide a brief encouraging note. Return JSON: { "advice": "string", "plan_updated": boolean }`;

      // Fire-and-forget — don't block the UI
      BrainKit.askClaude(prompt, { json: true }).then(result => {
        if (result && result.advice) {
          BrainKit.toast(result.advice, result.plan_updated ? 'warning' : 'success', 5000);
        }
      }).catch(e => console.error('Escalation failed:', e));
    } catch (e) {
      console.error('Escalation failed:', e);
    }
  }

  await saveLog();
  selectedFeel = 0;
  BrainKit.toast('Day logged', 'success');
  renderToday();
}

function renderDaySummary(container, today, headerHtml) {
  const totals = getTodayTotals();
  const targets = mealPlan.daily_targets;
  const adherence = Math.abs(totals.cal - targets.calories) <= targets.variance ? 'On target' : (totals.cal > targets.calories + targets.variance ? 'Over target' : 'Under target');
  const feelLabels = ['', 'Rough', 'Meh', 'Okay', 'Good', 'Great'];

  let mealsHtml = '';
  if (today.meals) {
    for (const m of today.meals) {
      const opt = getOptionById(m.option_id);
      const meal = getMealBySlot(m.slot);
      mealsHtml += `<div style="padding:3px 0;font-size:var(--font-size-sm);color:var(--text-secondary);">${meal?.name || 'Slot ' + m.slot}: ${opt?.label || m.option_id}</div>`;
    }
  }
  if (today.custom_meals) {
    for (const cm of today.custom_meals) {
      const meal = getMealBySlot(cm.slot);
      const cmMacros = getCustomMealMacros(cm);
      mealsHtml += `<div style="padding:3px 0;font-size:var(--font-size-sm);color:var(--text-secondary);">${meal?.name || 'Slot ' + cm.slot}: ${getCustomMealItemsLabel(cm)} (~${cmMacros.cal} cal)</div>`;
    }
  }

  container.innerHTML = (headerHtml || '') + `
    <div class="animate-in summary-card">
      <div class="summary-title">Day Complete</div>
      <div class="summary-grid">
        <div class="summary-item">
          <div class="summary-value">${today.weight}</div>
          <div class="summary-label">Weight (lbs)</div>
        </div>
        <div class="summary-item">
          <div class="summary-value">${feelLabels[today.end_of_day.feel] || '?'}</div>
          <div class="summary-label">Feeling</div>
        </div>
        <div class="summary-item">
          <div class="summary-value">${totals.cal}</div>
          <div class="summary-label">Calories</div>
        </div>
        <div class="summary-item">
          <div class="summary-value">${totals.protein}g</div>
          <div class="summary-label">Protein</div>
        </div>
      </div>
      <div style="font-size:var(--font-size-base);color:var(--text-muted);margin-bottom:var(--sp-sm);">${adherence}</div>
      ${today.end_of_day.steps ? `<div style="font-size:var(--font-size-sm);color:var(--text-muted);">Steps: ${today.end_of_day.steps.toLocaleString()}</div>` : ''}
      ${today.end_of_day.notes ? `<div style="font-size:var(--font-size-sm);color:var(--text-muted);font-style:italic;margin-top:4px;">"${today.end_of_day.notes}"</div>` : ''}
      <div style="margin-top:12px;text-align:left;">
        ${mealsHtml}
      </div>
      ${today.end_of_day.escalated_to_claude ? '<div class="escalation-note">Claude has been notified and will review</div>' : ''}
    </div>
  `;
}

// ============================================================
// RESET TODAY
// ============================================================
function openResetConfirm() {
  document.getElementById('confirm-modal').classList.add('open');
}

function closeConfirmModal() {
  document.getElementById('confirm-modal').classList.remove('open');
}

async function confirmResetToday() {
  closeConfirmModal();
  delete dailyLog[todayKey];
  await saveLog();
  BrainKit.toast('Today reset', 'success');
  renderToday();
}

// ============================================================
// CUSTOM MEAL MODAL
// ============================================================
function openCustomModal(slot) {
  currentCustomSlot = slot;
  document.getElementById('custom-modal').classList.add('open');
  document.getElementById('custom-meal-text').value = '';
  setTimeout(() => document.getElementById('custom-meal-text')?.focus(), 100);
}

function closeCustomModal() {
  document.getElementById('custom-modal').classList.remove('open');
}

async function submitCustomMeal() {
  const text = document.getElementById('custom-meal-text').value.trim();
  if (!text) return;

  const slot = currentCustomSlot;
  const meal = getMealBySlot(slot);
  closeCustomModal();

  // Show loading state
  customMealLoading = slot;
  renderToday();

  try {
    const now = new Date();
    const time = String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');

    const result = await BrainKit.askClaude(
      `Estimate the calories and protein for this meal: "${text}"

Return JSON only, no explanation:
{
  "items": ["item 1 (portion)", "item 2 (portion)"],
  "estimated_cal": number,
  "estimated_protein": number
}`,
      { json: true }
    );

    // Build the custom meal entry
    const entry = {
      slot,
      description: text,
      items: result.items || [text],
      estimated_cal: result.estimated_cal || 0,
      estimated_protein: result.estimated_protein || 0,
      time
    };

    // Add to today's log
    const today = getTodayData();
    if (today) {
      if (!today.custom_meals) today.custom_meals = [];
      today.custom_meals.push(entry);
      await saveLog();

      const macros = getCustomMealMacros(entry);
      const label = getCustomMealItemsLabel(entry);
      BrainKit.toast(`Logged: ~${macros.cal} cal, ${macros.protein}g protein`, 'success');
    }
  } catch (e) {
    console.error('Custom meal failed:', e);
    BrainKit.toast('Failed to estimate meal — try again?', 'error');
  } finally {
    customMealLoading = null;
    renderToday();
  }
}

// ============================================================
// TAB: PROGRESS
// ============================================================
function renderProgress() {
  const container = document.getElementById('progress-content');
  const dates = Object.keys(dailyLog).sort();
  const weights = dates.filter(d => dailyLog[d].weight).map(d => ({ date: d, weight: dailyLog[d].weight }));

  if (weights.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">No data yet. Log your first weight on the Today tab.</div>';
    return;
  }

  // EWMA calculation
  const alpha = 2 / (7 + 1);
  let ewma = [weights[0].weight];
  for (let i = 1; i < weights.length; i++) {
    ewma.push(alpha * weights[i].weight + (1 - alpha) * ewma[i - 1]);
  }

  // Stats
  const currentWeight = weights[weights.length - 1].weight;
  const startWeight = weights[0].weight;
  const totalLost = (startWeight - currentWeight).toFixed(1);
  const daysTracked = weights.length;
  const startDate = mealPlan?.start_date || dates[0];
  const daysSinceStart = Math.max(1, Math.ceil((new Date() - new Date(startDate)) / 86400000));

  // Weekly average cal/protein
  const last7 = dates.slice(-7);
  let weekCal = 0, weekPro = 0, weekDays = 0;
  for (const d of last7) {
    const t = getDayTotals(dailyLog[d]);
    if (t.cal > 0) { weekCal += t.cal; weekPro += t.protein; weekDays++; }
  }
  const avgCal = weekDays ? Math.round(weekCal / weekDays) : 0;
  const avgPro = weekDays ? Math.round(weekPro / weekDays) : 0;

  // TDEE estimate (needs 3+ weeks)
  let tdeeHtml = '';
  if (daysTracked >= 21 && weekDays > 0) {
    const weightChange = startWeight - currentWeight;
    const tdee = Math.round(avgCal + (weightChange * 3500 / daysTracked));
    tdeeHtml = `
      <div class="stat-badge">
        <div class="stat-value">${tdee}</div>
        <div class="stat-label">Est. TDEE</div>
      </div>
    `;
  }

  let html = `
    <div style="margin-bottom:var(--sp-lg);">
      <div style="font-size:var(--font-size-xl);font-weight:700;margin-bottom:4px;">Progress</div>
      <div style="font-size:var(--font-size-sm);color:var(--text-muted);">Weight trend over time</div>
    </div>

    <div class="chart-container">
      <canvas id="weight-chart" height="220"></canvas>
    </div>

    <div class="stat-row">
      <div class="stat-badge">
        <div class="stat-value">${currentWeight}</div>
        <div class="stat-label">Current (lbs)</div>
      </div>
      <div class="stat-badge">
        <div class="stat-value">${startWeight}</div>
        <div class="stat-label">Start (lbs)</div>
      </div>
      <div class="stat-badge">
        <div class="stat-value">${totalLost}</div>
        <div class="stat-label">Lost (lbs)</div>
      </div>
    </div>

    <div class="stat-row">
      <div class="stat-badge">
        <div class="stat-value">${avgCal}</div>
        <div class="stat-label">Avg Cal (7d)</div>
      </div>
      <div class="stat-badge">
        <div class="stat-value">${avgPro}g</div>
        <div class="stat-label">Avg Protein (7d)</div>
      </div>
      <div class="stat-badge">
        <div class="stat-value">${daysTracked}</div>
        <div class="stat-label">Days Tracked</div>
      </div>
      ${tdeeHtml}
    </div>

    <div style="margin-top:20px;">
      <div style="font-size:var(--font-size-md);font-weight:700;margin-bottom:10px;">Weekly Breakdown</div>
      <div id="weekly-breakdown"></div>
    </div>
  `;

  container.innerHTML = html;

  // Render chart
  renderWeightChart(weights, ewma);

  // Render weekly breakdown
  renderWeeklyBreakdown(dates);
}

function renderWeightChart(weights, ewma) {
  const ctx = document.getElementById('weight-chart');
  if (!ctx) return;

  if (weightChart) {
    weightChart.destroy();
    weightChart = null;
  }

  const labels = weights.map(w => {
    const d = new Date(w.date + 'T12:00:00');
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  });

  const accentColor = cssVar('--accent-primary');
  const mutedColor = cssVar('--text-muted');
  const borderClr = cssVar('--border-color');

  weightChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'Weight',
          data: weights.map(w => w.weight),
          borderColor: mutedColor,
          backgroundColor: 'transparent',
          borderWidth: 1.5,
          pointRadius: 4,
          pointBackgroundColor: accentColor,
          pointBorderColor: accentColor,
          tension: 0,
          fill: false
        },
        {
          label: 'Trend (7d EWMA)',
          data: ewma,
          borderColor: accentColor,
          borderWidth: 3,
          pointRadius: 0,
          tension: 0.3,
          fill: false,
          borderDash: []
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          labels: { color: mutedColor, font: { size: 11 }, boxWidth: 12, padding: 12 }
        },
        tooltip: {
          backgroundColor: cssVar('--bg-secondary'),
          titleColor: cssVar('--text-primary'),
          bodyColor: cssVar('--text-secondary'),
          borderColor: borderClr,
          borderWidth: 1,
          cornerRadius: 8,
          padding: 10
        }
      },
      scales: {
        x: {
          ticks: { color: mutedColor, font: { size: 10 } },
          grid: { color: borderClr + '4D' }
        },
        y: {
          ticks: { color: mutedColor, font: { size: 10 } },
          grid: { color: borderClr + '4D' },
          suggestedMin: Math.min(...weights.map(w => w.weight)) - 2,
          suggestedMax: Math.max(...weights.map(w => w.weight)) + 2
        }
      }
    }
  });
}

function renderWeeklyBreakdown(dates) {
  const el = document.getElementById('weekly-breakdown');
  if (!el) return;

  // Group by week (Mon-Sun)
  const weeks = {};
  for (const d of dates) {
    const date = new Date(d + 'T12:00:00');
    const day = date.getDay();
    const monday = new Date(date);
    monday.setDate(date.getDate() - ((day + 6) % 7));
    const weekKey = monday.toISOString().split('T')[0];
    if (!weeks[weekKey]) weeks[weekKey] = [];
    weeks[weekKey].push(d);
  }

  const weekKeys = Object.keys(weeks).sort().reverse();
  let html = '';
  for (const wk of weekKeys) {
    const days = weeks[wk];
    const weekWeights = days.filter(d => dailyLog[d].weight).map(d => dailyLog[d].weight);
    const avgWeight = weekWeights.length ? (weekWeights.reduce((a,b)=>a+b,0) / weekWeights.length).toFixed(1) : '—';
    let totalCal = 0, totalPro = 0, mealDays = 0;
    for (const d of days) {
      const t = getDayTotals(dailyLog[d]);
      if (t.cal > 0) { totalCal += t.cal; totalPro += t.protein; mealDays++; }
    }
    const avgCal = mealDays ? Math.round(totalCal / mealDays) : 0;
    const avgPro = mealDays ? Math.round(totalPro / mealDays) : 0;

    const weekLabel = formatDate(wk);

    html += `
      <div class="accordion">
        <div class="accordion-header" onclick="this.classList.toggle('open');this.nextElementSibling.classList.toggle('open');">
          <span>Week of ${weekLabel}</span>
          <span style="font-size:var(--font-size-sm);color:var(--text-muted);">Avg: ${avgWeight} lbs &middot; ${avgCal} cal</span>
        </div>
        <div class="accordion-body">
    `;
    for (const d of days.sort()) {
      const day = dailyLog[d];
      const t = getDayTotals(day);
      const feelLabels = ['', 'Rough', 'Meh', 'Okay', 'Good', 'Great'];
      const feel = day.end_of_day?.feel ? feelLabels[day.end_of_day.feel] : '—';
      html += `
        <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border-color);">
          <span>${formatDate(d)}</span>
          <span style="color:var(--text-muted);">${day.weight || '—'} lbs &middot; ${t.cal} cal &middot; ${t.protein}g &middot; ${feel}</span>
        </div>
      `;
    }
    html += '</div></div>';
  }

  el.innerHTML = html || '<div style="color:var(--text-muted);font-size:var(--font-size-base);">No weeks to show yet.</div>';
}

// ============================================================
// TAB: MEALS
// ============================================================
function renderMeals() {
  const container = document.getElementById('meals-content');
  if (!mealPlan) {
    container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">No meal plan loaded.</div>';
    return;
  }

  const freq = getOptionFrequency();
  let html = '<div style="font-size:var(--font-size-xl);font-weight:700;margin-bottom:var(--sp-lg);">Meal Plan</div>';

  for (const meal of mealPlan.meals) {
    html += `
      <div class="browse-slot">
        <div class="browse-slot-header">${meal.name}</div>
        <div class="browse-slot-sub">${meal.time_window} &middot; ${meal.target_cal} cal / ${meal.target_protein}g protein${meal.note ? ' &middot; ' + meal.note : ''}</div>
    `;

    for (const opt of meal.options) {
      const count = freq[opt.id] || 0;
      html += `
        <div class="browse-option" onclick="this.querySelector('.browse-option-items').classList.toggle('open')">
          <div class="browse-option-header">
            <span>
              <span class="browse-option-label">${opt.label}</span>
              ${count > 0 ? `<span class="browse-option-badge">${count}x</span>` : ''}
            </span>
            <span class="browse-option-macros">${opt.total_cal} cal / ${opt.total_protein}g</span>
          </div>
          <div class="browse-option-items">
            ${opt.items.map(it => `
              <div style="display:flex;justify-content:space-between;padding:3px 0;">
                <span>${it.name}</span>
                <span style="color:var(--text-muted);">${it.amount} &middot; ${it.cal} cal &middot; ${it.protein}g</span>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    html += '</div>';
  }

  container.innerHTML = html;
}

// ============================================================
// TAB: HISTORY
// ============================================================
function renderHistory() {
  const container = document.getElementById('history-content');
  const dates = getSortedDates();

  if (dates.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">No history yet.</div>';
    return;
  }

  let html = '<div style="font-size:var(--font-size-xl);font-weight:700;margin-bottom:var(--sp-lg);">History</div>';

  for (const d of dates) {
    const day = dailyLog[d];
    const totals = getDayTotals(day);
    const feelLabels = ['', 'Rough', 'Meh', 'Okay', 'Good', 'Great'];
    const feel = day.end_of_day?.feel || 0;

    const feelClass = feel >= 4 ? ' feel-good' : feel <= 2 && feel > 0 ? ' feel-bad' : '';

    html += `
      <div class="history-day${feelClass}" onclick="this.querySelector('.history-day-detail').classList.toggle('open')">
        <div class="history-day-header">
          <span class="history-day-date">${formatDate(d)}</span>
          <span class="history-day-weight">${day.weight ? day.weight + ' lbs' : '—'}</span>
        </div>
        <div class="history-day-macros">${totals.cal} cal &middot; ${totals.protein}g protein${feel ? ' &middot; ' + feelLabels[feel] : ''}</div>
        <div class="history-day-detail">
    `;

    if (day.meals) {
      for (const m of day.meals) {
        const opt = getOptionById(m.option_id);
        const meal = getMealBySlot(m.slot);
        html += `
          <div class="history-meal-line">
            <span>${meal?.name || 'Slot ' + m.slot}</span>
            <span style="color:var(--text-muted);">${opt?.label || m.option_id} (${opt?.total_cal || '?'} cal)</span>
          </div>
        `;
      }
    }
    if (day.custom_meals) {
      for (const cm of day.custom_meals) {
        const meal = getMealBySlot(cm.slot);
        const cmMacros = getCustomMealMacros(cm);
        html += `
          <div class="history-meal-line">
            <span>${meal?.name || 'Slot ' + cm.slot}</span>
            <span style="color:var(--text-muted);">${getCustomMealItemsLabel(cm)} (~${cmMacros.cal || '?'} cal)</span>
          </div>
        `;
      }
    }

    if (day.end_of_day) {
      if (day.end_of_day.steps) html += `<div class="history-feel">Steps: ${day.end_of_day.steps.toLocaleString()}</div>`;
      if (day.end_of_day.notes) html += `<div class="history-notes">"${day.end_of_day.notes}"</div>`;
    }

    html += '</div></div>';
  }

  container.innerHTML = html;
}

// ============================================================
// TAB: SETTINGS
// ============================================================
function renderSettings() {
  const container = document.getElementById('settings-content');
  if (!mealPlan) {
    container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">No meal plan loaded.</div>';
    return;
  }

  const startDate = mealPlan.start_date ? formatDate(mealPlan.start_date) : '—';
  const phase = mealPlan.phase ? mealPlan.phase.charAt(0).toUpperCase() + mealPlan.phase.slice(1) : '—';

  container.innerHTML = `
    <div style="font-size:var(--font-size-xl);font-weight:700;margin-bottom:var(--sp-lg);">Settings</div>

    <div class="settings-section">
      <div class="settings-label">Current Phase</div>
      <div class="settings-value">${phase} — started ${startDate}</div>
    </div>

    <div class="settings-section">
      <div class="settings-label">Daily Targets</div>
      <div class="settings-value">${mealPlan.daily_targets.calories} cal / ${mealPlan.daily_targets.protein}g protein</div>
    </div>

    <div class="settings-section">
      <div class="settings-label">Variance Allowance</div>
      <div class="settings-value">&plusmn; ${mealPlan.daily_targets.variance} cal</div>
    </div>

    <div class="settings-section">
      <div class="settings-label">Meal Slots</div>
      <div class="settings-value">${mealPlan.meals.length} meals/day</div>
    </div>

    <button class="btn btn-primary btn-large" style="margin-top:var(--sp-lg);" onclick="requestPlanUpdate()">
      Request Plan Update
    </button>

    <div style="margin-top:var(--sp-2xl);font-size:var(--font-size-xs);color:var(--text-muted);text-align:center;">
      Diet Tracker &middot; Second Brain App
    </div>
  `;
}

async function requestPlanUpdate() {
  BrainKit.toast('Reviewing your plan...', '', 10000);
  try {
    const dates = Object.keys(dailyLog).sort();
    const recentDates = dates.slice(-7);
    let summary = '';
    for (const d of recentDates) {
      const t = getDayTotals(dailyLog[d]);
      const w = dailyLog[d].weight || '?';
      const f = dailyLog[d].end_of_day?.feel || '?';
      summary += `${d}: ${w}lbs, ${t.cal}cal, ${t.protein}g pro, feel ${f}/5\n`;
    }

    const result = await BrainKit.askClaude(
      `Diet plan review requested.
Current phase: ${mealPlan.phase}
Current targets: ${mealPlan.daily_targets.calories} cal / ${mealPlan.daily_targets.protein}g protein
Recent 7 days:
${summary}

Analyze the trend and provide a brief assessment. Should targets be adjusted?
Return JSON: { "assessment": "1-2 sentence summary", "recommendation": "keep" | "adjust_down" | "adjust_up", "suggested_calories": number | null, "suggested_protein": number | null }`,
      { json: true }
    );

    if (result && result.assessment) {
      BrainKit.toast(result.assessment, result.recommendation === 'keep' ? 'success' : 'warning', 6000);
    } else {
      BrainKit.toast('Review complete', 'success');
    }
  } catch (e) {
    console.error('Plan update request failed:', e);
    BrainKit.toast('Failed to get review', 'error');
  }
}

// ============================================================
// INIT
// ============================================================
async function init() {
  todayKey = getToday();
  await loadData();
  renderToday();

  // Check for date change every 60s (handles overnight open)
  setInterval(() => {
    if (checkDateChange()) {
      renderToday();
    }
  }, 60000);
}

init();
</script>
</body>
</html>
